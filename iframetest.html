<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>SmartSimple – Interaction Panel (Test)</title>
<style>
    * { box-sizing: border-box; }
    body {
        font-family: "Segoe UI", Arial, sans-serif;
        margin: 0;
        padding: 16px 18px;
        background: #ffffff;
        color: #222;
        font-size: 13px;
    }

    /* Header */
    .header {
        display: flex;
        align-items: center;
        margin-bottom: 16px;
    }
    .logo-circle {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        border: 1px solid #e0e0e0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 13px;
        font-weight: 600;
        color: #3c8f4a;
        margin-right: 8px;
    }
    .header-title {
        font-size: 18px;
        font-weight: 400;
    }

    .subtext {
        margin-bottom: 12px;
        color: #666;
        line-height: 1.4;
    }

    /* Field Labels / Values */
    .field-label {
        font-size: 11px;
        text-transform: uppercase;
        color: #888;
        margin-top: 10px;
        margin-bottom: 2px;
        letter-spacing: 0.03em;
    }
    .field-value {
        font-size: 13px;
        margin-bottom: 4px;
        color: #222;
    }
    .field-value-muted {
        font-size: 12px;
        color: #666;
        margin-bottom: 4px;
    }

    /* Organization green box */
    .org-box-wrapper {
        margin-top: 4px;
        margin-bottom: 4px;
    }
    .org-box {
        border: 2px solid #3c8f4a;
        border-radius: 4px;
        padding: 6px 8px;
    }
    .org-box select {
        width: 100%;
        border: none;
        outline: none;
        background: transparent;
        font-size: 13px;
    }

    /* Request dropdown */
    select.request-select {
        width: 100%;
        padding: 6px 8px;
        font-size: 13px;
        border-radius: 2px;
        border: 1px solid #ccc;
        background: #fff;
    }

    /* Notes Area */
    .notes-area textarea {
        width: 100%;
        height: 120px;
        border-radius: 3px;
        border: 1px solid #d0d0d0;
        outline: none;
        resize: vertical;
        padding: 6px 8px;
        font-size: 13px;
        font-family: "Segoe UI", Arial, sans-serif;
        margin-top: 4px;
    }

    /* Bottom Button */
    .footer-actions {
        margin-top: 18px;
        display: flex;
        justify-content: flex-end;
    }
    .primary-btn {
        padding: 7px 16px;
        font-size: 13px;
        border-radius: 3px;
        border: none;
        background-color: #3c8f4a;
        color: #fff;
        cursor: pointer;
    }
    .primary-btn:hover {
        background-color: #2f6f3a;
    }
</style>
</head>
<body>

<!-- Header -->
<div class="header">
    <div class="logo-circle">SS</div>
    <div class="header-title">SSSimple</div>
</div>

<div class="subtext" id="introText">
    Create a new Interaction record for SSSimple from this email.
</div>

<!-- Interaction Title -->
<div class="field-label">Interaction Title</div>
<div class="field-value" id="interactionTitle">Loading subject…</div>

<!-- Messages -->
<div class="field-label">Messages</div>
<div class="field-value" id="messageCount">1 Message</div>

<!-- Contacts -->
<div class="field-label">Contacts</div>
<div class="field-value" id="contactName">Loading contact…</div>
<div class="field-value-muted" id="contactEmail"></div>

<!-- Organization -->
<div class="field-label">Organization</div>
<div class="org-box-wrapper">
    <div class="org-box">
        <select id="organizationSelect">
            <option value="grantseeking-org">Grantseeking Organization</option>
            <option value="new-hope-foundation">New Hope Foundation</option>
            <option value="community-support">Community Support Alliance</option>
        </select>
    </div>
</div>

<!-- Request -->
<div class="field-label">Request</div>
<select class="request-select" id="requestSelect">
    <option value="">Select Request</option>
    <option value="letter-of-inquiry">Letter of Inquiry</option>
    <option value="full-proposal">Full Proposal</option>
    <option value="site-visit">Site Visit Follow-up</option>
</select>

<!-- Notes -->
<div class="field-label">Interaction Notes</div>
<div class="notes-area">
    <textarea id="notesTextarea" placeholder="Enter notes…"></textarea>
</div>

<!-- Bottom button -->
<div class="footer-actions">
    <button class="primary-btn" id="createInteractionBtn">Create Interaction</button>
</div>

<!-- Office.js -->
<script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>

<script>
(function () {
    const API_URL = "https://example.com/api/outlook/interaction";

    let outlookItem = null; // Office.context.mailbox.item 저장용

    // Outside Outlook fallback
    if (!window.Office) {
        console.log("Office.js not found – using fallback values.");
        document.getElementById("interactionTitle").textContent = "Letter of Inquiry (Test)";
        document.getElementById("contactName").textContent = "Sally Grantseeker";
        document.getElementById("contactEmail").textContent = "stacey.dabaldo@SSSimple.com";

        document.getElementById("createInteractionBtn").addEventListener("click", function () {
            const payload = {
                source: "browser-fallback",
                interactionTitle: document.getElementById("interactionTitle").textContent,
                organization: document.getElementById("organizationSelect").value,
                request: document.getElementById("requestSelect").value,
                notes: document.getElementById("notesTextarea").value
            };
            console.log("Payload (fallback, not Outlook):", payload);
            alert("Test only (no Outlook item). Check console for payload.");
        });
        return;
    }

    Office.onReady(function (info) {
        if (info.host !== Office.HostType.Outlook) {
            console.log("Host is not Outlook:", info.host);
            return;
        }

        outlookItem = Office.context.mailbox.item;

        // Subject → Interaction Title
        document.getElementById("interactionTitle").textContent =
            outlookItem.subject || "(No subject)";

        // From → Contact
        if (outlookItem.from) {
            document.getElementById("contactName").textContent =
                outlookItem.from.displayName || outlookItem.from.emailAddress || "Unknown sender";
            document.getElementById("contactEmail").textContent =
                outlookItem.from.emailAddress || "";
        }

        document.getElementById("messageCount").textContent = "1 Message";

        document.getElementById("createInteractionBtn").addEventListener("click", onCreateInteractionClick);
    });

    function onCreateInteractionClick() {
        if (!outlookItem) {
            console.warn("Outlook item not ready yet.");
            alert("Outlook item not ready yet.");
            return;
        }

        outlookItem.body.getAsync("text", function (result) {
            if (result.status !== Office.AsyncResultStatus.Succeeded) {
                console.error("Failed to get body:", result.error);
                alert("Failed to read email body.");
                return;
            }

            const bodyText = result.value || "";

            // Recipients (To)
            const toRecipients = (outlookItem.to || []).map(function (rec) {
                return {
                    displayName: rec.displayName,
                    emailAddress: rec.emailAddress
                };
            });

            // CC 
            const ccRecipients = (outlookItem.cc || []).map(function (rec) {
                return {
                    displayName: rec.displayName,
                    emailAddress: rec.emailAddress
                };
            });

            // Attachments
            const attachments = (outlookItem.attachments || []).map(function (att) {
                return {
                    id: att.id,
                    name: att.name,
                    contentType: att.contentType,
                    size: att.size,
                    isInline: att.isInline
                };
            });

            // UI values
            const organization = document.getElementById("organizationSelect").value;
            const request = document.getElementById("requestSelect").value;
            const notes = document.getElementById("notesTextarea").value;
            const interactionTitle = document.getElementById("interactionTitle").textContent;

            // Metadata + basic info
            const payload = {
                interactionTitle: interactionTitle,
                organization: organization,
                request: request,
                notes: notes,

                // Outlook basic info
                subject: outlookItem.subject,
                body: bodyText,
                from: outlookItem.from ? {
                    displayName: outlookItem.from.displayName,
                    emailAddress: outlookItem.from.emailAddress
                } : null,
                toRecipients: toRecipients,
                ccRecipients: ccRecipients,

                dateTimeCreated: outlookItem.dateTimeCreated || null,
                dateTimeReceived: outlookItem.dateTimeReceived || null,

                // Metadata
                itemId: outlookItem.itemId || null,
                conversationId: outlookItem.conversationId || null,
                internetMessageId: outlookItem.internetMessageId || null,

                // Attachments (metadata only)
                attachments: attachments
            };

            console.log("Payload to send to API:", payload);

            // api call 
/*
            fetch(API_URL, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(payload)
            })
            .then(function (res) {
                console.log("API response status:", res.status);
                alert("Interaction payload sent to API (mock). Check console for details.");
            })
            .catch(function (err) {
                console.error("API call failed:", err);
                alert("Failed to send interaction to API. See console for details.");
            });
*/
        });
    }
})();
</script>

</body>
</html>
